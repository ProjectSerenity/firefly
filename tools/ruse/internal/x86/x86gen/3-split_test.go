// Copyright 2023 The Firefly Authors.
//
// Use of this source code is governed by a BSD 3-clause
// license that can be found in the LICENSE file.

package main

import (
	"testing"

	"github.com/google/go-cmp/cmp"
	"rsc.io/pdf"
)

func TestSplitInstructionPages(t *testing.T) {
	tests := []struct {
		Name      string
		Pages     []Page
		Mnemonics []Page
		Encodings []Page
	}{
		{
			// Simple single page.
			Name:  "190",
			Pages: []Page{page190},
			Mnemonics: []Page{
				{
					Page: 190,
					Text: []pdf.Text{
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 48.119699999999995, Y: 700.9797, W: 125.7267,
							S: "Opcode/Instruction"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 172.0983, Y: 700.9797, W: 186.5523,
							S: "Op/"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 202.62, Y: 700.9797, W: 230.8935,
							S: "64/32-"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 242.3397, Y: 700.9797, W: 267.0186,
							S: "CPUID"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 286.61969999999997, Y: 700.9797, W: 332.4656999999999,
							S: "Description"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 172.1397, Y: 689.9997, W: 182.2845,
							S: "En"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 202.62, Y: 689.9997, W: 213.5046,
							S: "bit"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 242.3397, Y: 689.9997, W: 274.2105,
							S: "Feature"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 202.62, Y: 679.0197, W: 224.6367,
							S: "Mode"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 242.3397, Y: 679.0197, W: 259.4586,
							S: "Flag"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 48.119699999999966, Y: 664.0194, W: 132.76739999999995,
							S: "VEX.LZ.0F38.W0 F2 /r"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 172.13969999999995, Y: 664.0194, W: 189.78689999999995,
							S: "RVM"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 202.64789999999994, Y: 664.0194, W: 217.08119999999994,
							S: "V/V"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 242.36309999999995, Y: 664.0194, W: 261.5879999999999,
							S: "BMI1"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 286.6232999999999, Y: 664.0194, W: 524.0982000000001,
							S: "Bitwise AND of inverted r32b with r/m32, store result in r32a."},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 48.119699999999966, Y: 652.9791, W: 141.78629999999993,
							S: "ANDN r32a, r32b, r/m32"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 48.11969999999995, Y: 637.9797, W: 134.97779999999995,
							S: "VEX.LZ. 0F38.W1 F2 /r"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 172.13969999999995, Y: 637.9797, W: 189.75989999999993,
							S: "RVM"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 202.62089999999992, Y: 637.9797, W: 221.9996999999999,
							S: "V/NE"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 242.3558999999999, Y: 637.9797, W: 261.6032999999999,
							S: "BMI1"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 286.6385999999999, Y: 637.9797, W: 524.0945999999999,
							S: "Bitwise AND of inverted r64b with r/m64, store result in r64a."},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 48.11969999999995, Y: 626.9997, W: 141.7862999999999,
							S: "ANDN r64a, r64b, r/m64"},
					},
				},
			},
			Encodings: []Page{
				{
					Page: 190,
					Text: []pdf.Text{
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 54.35939999999988, Y: 574.0194, W: 78.96179999999988,
							S: "Op/En"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 122.93399999999988, Y: 574.0194, W: 164.96399999999994,
							S: "Operand 1"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 236.94689999999997, Y: 574.0194, W: 279.09659999999997,
							S: "Operand 2"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 354.25919999999996, Y: 574.0194, W: 396.28919999999994,
							S: "Operand 3"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 474.5720999999999, Y: 574.0194, W: 516.7145999999999,
							S: "Operand 4"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 57.83969999999988, Y: 557.9994, W: 75.53279999999988,
							S: "RVM"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 115.69439999999989, Y: 557.9994, W: 172.30709999999993,
							S: "ModRM:reg (w)"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 234.57449999999992, Y: 557.9994, W: 281.52299999999985,
							S: "VEX.vvvv (r)"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 348.47039999999987, Y: 557.9994, W: 402.2057999999998,
							S: "ModRM:r/m (r)"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 488.41319999999985, Y: 557.9994, W: 502.95899999999983,
							S: "N/A"},
					},
				},
			},
		},
		{
			// Double page instruction.
			Name:  "206",
			Pages: []Page{page206, page207},
			Mnemonics: []Page{
				{
					Page: 206,
					Text: []pdf.Text{
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 48.11969999999999, Y: 700.9827, W: 81.79230000000001,
							S: "Opcode/"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 257.8197, Y: 700.9827, W: 272.27729999999997,
							S: "Op/"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 283.3797, Y: 700.9827, W: 322.58820000000003,
							S: "64/32-bit"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 331.37940000000003, Y: 700.9827, W: 356.06640000000004,
							S: "CPUID"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 378.1191, Y: 700.9827, W: 423.96509999999995,
							S: "Description"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 48.11969999999999, Y: 691.0224000000001, W: 92.10269999999998,
							S: "Instruction"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 257.8197, Y: 691.0224000000001, W: 268.0239,
							S: "En"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 283.3797, Y: 691.0224000000001, W: 305.3964,
							S: "Mode"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 331.37940000000003, Y: 691.0224000000001, W: 363.25020000000006,
							S: "Feature"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 331.37940000000003, Y: 681.0027, W: 348.4983000000001,
							S: "Flag"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 48.11880000000002, Y: 666.0024000000001, W: 114.32910000000001,
							S: "66 0F 3A 0D /r ib"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 257.8188, Y: 666.0024000000001, W: 271.91549999999995,
							S: "RMI"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 283.37969999999996, Y: 666.0024000000001, W: 297.8066999999999,
							S: "V/V"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 331.36859999999996, Y: 666.0024000000001, W: 360.6987,
							S: "SSE4_1"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 378.1137, Y: 666.0024000000001, W: 547.9176,
							S: "Select packed double precision floating-point"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 378.1191, Y: 655.0224000000001, W: 537.8286000000003,
							S: "values from xmm1 and xmm2/m128 from"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 48.11880000000002, Y: 652.0227000000001, W: 189.64740000000006,
							S: "BLENDPD xmm1, xmm2/m128, imm8"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 378.1191, Y: 643.9821000000001, W: 546.3525000000002,
							S: "mask specified in imm8 and store the values"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 378.1191, Y: 633.0021, W: 420.7332,
							S: "into xmm1."},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 48.11880000000002, Y: 618.0018, W: 163.2954000000001,
							S: "VEX.128.66.0F3A.WIG 0D /r ib"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 257.8188, Y: 618.0018, W: 277.37669999999997,
							S: "RVMI"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 283.38059999999996, Y: 618.0018, W: 297.82019999999994,
							S: "V/V"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 331.3821, Y: 618.0018, W: 348.3246,
							S: "AVX"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 378.1245, Y: 618.0018, W: 547.9284,
							S: "Select packed double precision floating-point"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 378.1191, Y: 607.0218, W: 538.8402,
							S: "Values from xmm2 and xmm3/m128 from"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 48.11880000000002, Y: 604.0221, W: 223.33619999999993,
							S: "VBLENDPD xmm1, xmm2, xmm3/m128, imm8"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 378.1191, Y: 595.9815, W: 547.0769999999998,
							S: "mask in imm8 and store the values in xmm1."},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 48.118799999999965, Y: 580.9812, W: 163.29540000000003,
							S: "VEX.256.66.0F3A.WIG 0D /r ib"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 257.8188, Y: 580.9812, W: 277.37669999999997,
							S: "RVMI"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 283.38059999999996, Y: 580.9812, W: 297.82019999999994,
							S: "V/V"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 331.3821, Y: 580.9812, W: 348.3246,
							S: "AVX"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 378.1245, Y: 580.9812, W: 547.9284,
							S: "Select packed double precision floating-point"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 378.1191, Y: 570.0011999999999, W: 538.6323,
							S: "Values from ymm2 and ymm3/m256 from"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 48.118799999999965, Y: 567.0015, W: 222.99510000000006,
							S: "VBLENDPD ymm1, ymm2, ymm3/m256, imm8"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 378.1191, Y: 559.0211999999999, W: 546.9617999999998,
							S: "mask in imm8 and store the values in ymm1."},
					},
				},
			},
			Encodings: []Page{
				{
					Page: 206,
					Text: []pdf.Text{
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 53.99849999999998, Y: 505.9814999999999, W: 78.64769999999996,
							S: "Op/En"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 122.19959999999996, Y: 505.9814999999999, W: 164.24939999999998,
							S: "Operand 1"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 236.23229999999995, Y: 505.9814999999999, W: 278.40899999999993,
							S: "Operand 2"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 352.43219999999997, Y: 505.9814999999999, W: 394.48380000000003,
							S: "Operand 3"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 472.70640000000003, Y: 505.9814999999999, W: 514.8183,
							S: "Operand 4"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 59.21849999999998, Y: 489.96149999999994, W: 73.28909999999998,
							S: "RMI"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 111.21329999999999, Y: 489.96149999999994, W: 175.1628,
							S: "ModRM:reg (r, w)"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 230.41019999999997, Y: 489.96149999999994, W: 284.18879999999996,
							S: "ModRM:r/m (r)"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 362.9559, Y: 489.96149999999994, W: 383.99699999999996,
							S: "imm8"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 486.55199999999996, Y: 489.96149999999994, W: 501.1185,
							S: "N/A"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 56.39879999999998, Y: 474.00179999999995, W: 76.20869999999998,
							S: "RVMI"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 114.91229999999999, Y: 474.00179999999995, W: 171.5385,
							S: "ModRM:reg (w)"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 233.80589999999998, Y: 474.00179999999995, W: 280.75710000000004,
							S: "VEX.vvvv (r)"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 346.5642000000001, Y: 474.00179999999995, W: 400.21950000000015,
							S: "ModRM:r/m (r)"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 474.2463000000002, Y: 474.00179999999995, W: 513.1497000000003,
							S: "imm8[3:0]"},
					},
				},
			},
		},
		{
			// Multi-page instruction.
			Name:      "657",
			Pages:     []Page{page657, page658, page659, page660, page661},
			Mnemonics: []Page{page657, page658, page659},
			Encodings: []Page{
				{
					Page: 660,
					Text: []pdf.Text{
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 57.48000000000005, Y: 700.98, W: 82.12380000000005,
							S: "Op/En"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 130.29540000000003, Y: 700.98, W: 172.39650000000006,
							S: "Operand 1"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 242.75940000000008, Y: 700.98, W: 284.86050000000006,
							S: "Operand 2"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 357.86310000000003, Y: 700.98, W: 399.96150000000006,
							S: "Operand 3"},
						{Font: "NeoSansIntelMedium", FontSize: 9,
							X: 476.7441, Y: 700.98, W: 518.7848999999999,
							S: "Operand 4"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 67.02000000000005, Y: 685.0203, W: 72.55500000000005,
							S: "D"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 139.01820000000004, Y: 685.0203, W: 163.51260000000002,
							S: "Offset"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 256.4979, Y: 685.0203, W: 271.04460000000006,
							S: "N/A"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 371.6376, Y: 685.0203, W: 386.2437000000001,
							S: "N/A"},
						{Font: "NeoSansIntel", FontSize: 9,
							X: 490.49610000000007, Y: 685.0203, W: 505.10310000000015,
							S: "N/A"},
					},
				},
			},
		},
	}

	for _, test := range tests {
		t.Run(test.Name, func(t *testing.T) {
			mnemonics, encodings := SplitInstructionPages(test.Pages, nil, false)
			if diff := cmp.Diff(test.Mnemonics, mnemonics); diff != "" {
				t.Fatalf("Mnemonic tables: (-want, +got)\n%s", diff)
			}
			if diff := cmp.Diff(test.Encodings, encodings); diff != "" {
				t.Fatalf("Operand encoding tables: (-want, +got)\n%s", diff)
			}
		})
	}
}
